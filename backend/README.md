## WHY?

This is the backend library for the Tamed Stripe architecture. This library aims to provide the backend integrations with the Stripe API servers for basic customer generation, connected account generation, payment and refund functions.

## SETUP

1. Add the backend library to the backend of your project.

```bash
yarn add tamed-stripe-backend
```

2. Initialize parameters (modify below object according to your environment)

	Use [this file](https://github.com/MehmetKaplan/tamed-stripe/blob/master/example/server-parameters.js) as a template for your backend configuration. This file is to be `require`d by your express server in the next step. **You should modify the credentials, according to your environment.**

	| Key | Type | Value |
	| --- | --- | --- |
	| pgKeys | Object | PostgreSQL connection parameters. |
	| httpsKeys | Object | HTTPS connection parameters. |
	| port | Number | Port number for the server. |
	
3. Call the `init` function of the library to initialize the db connection pool. And then start your server. As a reference you can use [this file](https://github.com/MehmetKaplan/tamed-stripe/blob/master/example/server.js).

## API

### `init`

| Parameter | Type | Description |
| --- | --- | --- |
| p_params | Object | Parameters for the backend server. |

#### `p_params`

| Key | Type | Value |
| --- | --- | --- |
| pgKeys | Object | PostgreSQL connection parameters. |
| httpsKeys | Object | HTTPS connection parameters. |
| port | Number | Port number for the server. |
| applicationName | String | Application name. Not used, reserved for future. |

**Returns:** If successful, resolves to `true`. Otherwise, rejects with an error message.

**Example:**
```javascript
await tsb.init({
	debugMode: true,
	// coming from database-setup
	pgKeys: {
		user: 'tamedstripeapp',
		password: 'tamedstripeapp.', 
		database: 'tamedstripedb',
		host: 'localhost',
		port: 5432,
	},
	port: 3000,
});
```

### generateCustomer

Generates a **payer** customer at Stripe.

| Parameter | Type | Description |
| --- | --- | --- |
| props | Object | Parameters for the generating a payer customer at Stripe |

#### `props`

| Key | Type | Value |
| --- | --- | --- |
| description | string | Description of the customer. |
| email | string | Email of the customer. |
| metadata | Object | Metadata for the customer, you can embed andy data within this object, it is kept in Stripe servers also. |
| name | string | Name of the customer. |
| phone | string | Phone number of the customer. |
| address | Object | Address of the customer. |

###### `address`

| Key | Type | Value |
| --- | --- | --- |
| city | string | City of the customer. |
| country | string | Country of the customer. |
| line1 | string | Line 1 of the address of the customer. |
| line2 | string | Line 2 of the address of the customer. |
| postal_code | string | Postal code of the customer. |
| state | string | State of the customer. |

**Returns:** If successful, resolves to below JSON object. Otherwise, rejects with an error message.
```js
{
	result: 'OK',
	payload: customer,
}
```

**Example:**
```javascript
	const props = {
		description, email, metadata, name, phone, address
	};
	let response = await tsb.generateCustomer(props);
```

### generateAccount

Generates a **payee** account (aka connected account) at Stripe.

| Parameter | Type | Description |
| --- | --- | --- |
| props | Object | Parameters for the generating a payee account at Stripe |

#### `props`

| Key | Type | Value |
| --- | --- | --- |
| email | string | Email of the account. |

**Returns:** If successful, resolves to below JSON object. Otherwise, rejects with an error message.
```js
{
	result: 'OK',
	payload: account,
}
```

**Example:**
```javascript
	const props = {
		email: email,
	};
	let response = await tsb.generateAccount(props);
```

### paymentSheetHandler

The payment sheet handler is used to generate a payment sheet for the payer customer. The payment sheet is a Stripe object that is used to collect the payment information from the payer customer. The payment sheet is generated by Stripe servers and is returned to the client. The client then uses the payment sheet to collect the payment information from the payer customer. The payment sheet data is to be used by the frontend.

| Parameter | Type | Description |
| --- | --- | --- |
| props | Object | Parameters for the generating a payment sheet at Stripe |

#### `props`

| Key | Type | Value |
| --- | --- | --- |
| customerId | string | Id of the payer customer. |
| payInAmount | number | Amount to be paid by the payer customer. |
| currency | string | Currency of the payment. |
| payoutData | Object | Data for the payee account. If there is no payout action provide Ã¹ndefined`. |

###### `payoutData`

| Key | Type | Value |
| --- | --- | --- |
| payoutAmount | number | Amount to be paid to the payee account. |
| payoutAccountId | string | Id of the payee account. |

**Returns:** If successful, resolves to below JSON object. Otherwise, rejects with an error message.
```js
{
	result: 'OK',
	payload: {
		paymentIntent: paymentIntent.client_secret,
		ephemeralKey: ephemeralKey.secret,
		customer: customerId,
		publishableKey: stripePK
	},
}
```

**Example:**
```javascript
	let paymentSheet_ = await tsb.paymentSheetHandler({ customerId, payInAmount, currency });
	let paymentSheet = paymentSheet_.payload;;
```

### refundHandler

Used to refund a payment.

| Parameter | Type | Description |
| --- | --- | --- |
| props | Object | Parameters for the refunding a payment at Stripe |

#### `props`

| Key | Type | Value |
| --- | --- | --- |
| chargeId | string | Id of the charge to be refunded. |

**Returns:** If successful, resolves to below JSON object. Otherwise, rejects with an error message.
```js
{
	result: 'OK',
	payload: refund,
}
```

**Example:**
```javascript
MODIFYME
```

## More Examples

The example application can be found [here](https://github.com/MehmetKaplan/tamed-stripe/blob/master/example).
Also the jest test cases can be used as examples, which can be found [here](https://github.com/MehmetKaplan/tamed-stripe/blob/master/backend/__tests__/tamed-stripe-backend.test.js).

## License

The license is MIT and full text [here](https://github.com/MehmetKaplan/tamed-stripe/blob/master/LICENSE).

#### Used Modules

Please refer to the [main github page](https://github.com/MehmetKaplan/tamed-stripe) for the list of used modules. 